apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-script
  namespace: ai-services
data:
  stress-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';

    export const options = {
      vus: 50,
      duration: '60s',
      thresholds: {
        http_req_duration: ['p(95)<2000'], // 95% of requests should be below 2s
        http_req_failed: ['rate<0.01'], // Less than 1% errors
      },
    };

    export default function () {
      // Internal cluster DNS for the service
      const url = 'http://ai-knowledge-hub-mcp:3000/debug/search';
      const queries = ['para', 'cliente', 'advogado'];
      const randomQuery = queries[Math.floor(Math.random() * queries.length)];
      
      const payload = JSON.stringify({
        query: randomQuery,
      });

      const params = {
        headers: {
          'Content-Type': 'application/json',
        },
      };

      const res = http.post(url, payload, params);
      
      check(res, {
        'status was 200': (r) => r.status == 200,
        'has results': (r) => r.body.includes('Found'),
      });
      
      sleep(1);
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: stress-test
  namespace: ai-services
spec:
  backoffLimit: 0
  template:
    spec:
      containers:
      - name: k6
        image: grafana/k6:latest
        command: ["k6", "run", "/scripts/stress-test.js"]
        volumeMounts:
        - name: script
          mountPath: /scripts
      restartPolicy: Never
      volumes:
      - name: script
        configMap:
          name: k6-script
